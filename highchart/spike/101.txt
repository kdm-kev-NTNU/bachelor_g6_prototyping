# Highcharts-LLM Analyzer v0.3 - Data Prosessering

## Arkitektur Oversikt

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Frontend   â”‚â”€â”€â”€â”€â–¶â”‚   Backend           â”‚â”€â”€â”€â”€â–¶â”‚   GPT-4o        â”‚â”€â”€â”€â”€â–¶â”‚   Backend  â”‚
â”‚  (Chart)    â”‚     â”‚ (server.py)         â”‚     â”‚   (OpenAI)      â”‚     â”‚(apply_find)â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                    â”‚                    â”‚                    â”‚
       â”‚ RÃ¥ data           â”‚ Pre-prosessert    â”‚ Semantiske        â”‚ Highcharts
       â”‚ [[ts, val], ...]  â”‚ prompt            â”‚ funn (JSON)       â”‚ config
       â”‚
       â”‚           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚ TimesFM Prediksjon â”‚â”€â”€â”€â”€â–¶â”‚ Prognose-serie  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚ (prediction_service)â”‚     â”‚ + Konfidensint. â”‚
                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Steg 1: Frontend â†’ Backend

### Analyse-endepunkt
Frontend sender chart-data via POST `/analyze`:

```json
{
  "seriesData": [[1483228800000, 20.15], [1483315200000, 21.03], ...],
  "title": "TSLA Stock Price",
  "timeRange": { "start": "2017-01-01", "end": "2025-03-17" },
  "yAxisLabel": "USD",
  "existingAnnotations": [...]
}
```

### Chat-endepunkt
Frontend sender spÃ¸rsmÃ¥l via POST `/chat`:

```json
{
  "message": "Hva kan skje neste 30 dager?",
  "chartContext": {
    "title": "TSLA Stock Price",
    "dataPoints": 2048,
    "timeRange": {"start": "2017-01-01", "end": "2025-03-17"},
    "currentAnalysis": "Bullish trend identifisert..."
  },
  "seriesData": [[1483228800000, 20.15], ...]
}
```

### Prediksjon-endepunkt
Direkte prediksjon via POST `/predict`:

```json
{
  "seriesData": [[1483228800000, 20.15], ...],
  "horizon": 30,
  "frequency": "D",
  "scenario": "bullish"
}
```

## Steg 2: Backend Pre-prosessering (server.py)

### Statistikk-beregning
Python beregner nÃ¸kkelstatistikk FÃ˜R LLM-kall:

- `total_points`: Antall datapunkter (f.eks. 2048)
- `min_value`, `max_value`: Prisekstremer
- `start_value`, `end_value`: Start/slutt-verdier
- `change_percent`: Prosentvis endring over perioden
- `avg_value`: Gjennomsnittspris
- `volatility`: (max - min) / avg * 100

### Sampling
For Ã¥ spare tokens sampels ~100 punkter fra datasettet:
```python
step = len(data) // sample_size
sampled_data = [data[i] for i in range(0, len(data), step)][:sample_size]
```

### Ekstrempunkt-deteksjon
`find_local_extremes()` identifiserer lokale topper/bunner:
- Bruker et vindu pÃ¥ 20 punkter
- Returnerer top 5 peaks og dips

## Steg 2.5: Prediksjon (TimesFM eller fallback)

### TimesFM-prediksjon
Hvis tilgjengelig brukes Google TimesFM:
- `prediction_service.py` konverterer data til pandas DataFrame
- KjÃ¸r prediksjon med spesifisert horisont
- Appliser scenario-modifikasjoner (bullish/bearish/volatile)

### Fallback-prediksjon
Sesongbasert prediksjon nÃ¥r TimesFM ikke er tilgjengelig:
- LineÃ¦r trend-analyse
- SesongmÃ¸nster-deteksjon (24 timer eller 7 dager)
- Tilfeldig stÃ¸y for realisme

### Scenarioer
Prediksjoner kan modifiseres med scenarioer:
- `bullish`: Multipliser trend med 1.2
- `bearish`: Multipliser trend med 0.8
- `volatile`: Ã˜k standardavvik

## Steg 3: LLM Analyse (GPT-4o)

LLM-en mottar en strukturert prompt:

```
DATASETT INFO:
- Tittel: TSLA Stock Price
- Periode: 2017-01-01 til 2025-03-17
- MÃ¥leenhet: USD

STATISTIKK:
{
  "total_points": 2048,
  "min_value": 19.33,
  "max_value": 402.86,
  "change_percent": 1147.52,
  ...
}

IDENTIFISERTE EKSTREMPUNKTER:
{
  "peaks": [...],
  "dips": [...]
}

DATA (samplet):
2017-01-03: 20.15
2017-01-24: 21.03
...
```

### LLM Output (Kun semantiske funn!)

```json
{
  "findings": [
    {
      "type": "BULLISH_TREND",
      "confidence": 0.88,
      "timeRange": ["2024-11-01", "2024-12-31"],
      "description": "Sterk oppgang etter valget"
    },
    {
      "type": "UNUSUAL_PEAK",
      "confidence": 0.92,
      "pointDate": "2021-11-04",
      "pointValue": 402.86
    }
  ],
  "summary": "Analysen viser at TSLA har hatt...",
  "overallTrend": "bullish",
  "riskAssessment": "medium"
}
```

## Steg 4: Deterministisk Visualisering (apply_findings.py)

Backend mapper semantiske funn til Highcharts-konfigurasjon:

| Funn-type       | Highcharts Element      | Preset                |
|-----------------|-------------------------|-----------------------|
| BULLISH_TREND   | plotBand (grÃ¸nn)        | `PLOT_BAND_PRESETS`   |
| BEARISH_TREND   | plotBand (rÃ¸d)          | `PLOT_BAND_PRESETS`   |
| UNUSUAL_PEAK    | annotation (punkt)      | `ANNOTATION_PRESETS`  |
| SUPPORT_LEVEL   | plotLine (horisontal)   | `PLOT_LINE_PRESETS`   |

### Prediksjon-visualisering
Prognoser vises som:
- **Stiplet oransje linje** - Hovedprediksjon
- **To stiplete linjer** - Ã˜vre/nedre konfidensgrense
- **Vertikal markÃ¸r** - Skille mellom historikk og prognose

### Eksempel mapping:

```python
# Input: semantisk funn
finding = {
    "type": "BULLISH_TREND",
    "timeRange": ["2024-11-01", "2024-12-31"]
}

# Output: Highcharts plotBand
{
    "from": 1730419200000,
    "to": 1735689600000,
    "color": "rgba(0, 255, 136, 0.15)",
    "label": {
        "text": "ğŸ“ˆ Bullish",
        "style": {"color": "#00ff88"}
    }
}
```

## Hvorfor denne arkitekturen?

### Kjerneprinsipper
1. **Deterministisk**: Samme funn â†’ alltid samme visualisering
2. **Kontrollert**: LLM kan ikke injisere vilkÃ¥rlig Highcharts-kode
3. **Vedlikeholdbar**: Visuelle presets definert pÃ¥ ett sted
4. **Token-effektiv**: Pre-beregnet statistikk reduserer LLM-arbeid
5. **Interaktiv**: Naturlig sprÃ¥k-grensesnitt for prediksjoner

### Forbedringer i v0.3
- **TimesFM-integrasjon**: State-of-the-art tidsserie-prediksjon
- **Chat-grensesnitt**: Automatisk prediksjons-deteksjon fra naturlig sprÃ¥k
- **Scenario-stÃ¸tte**: "Hva hvis"-analyser (bullish/bearish/volatile)
- **Fallback-system**: Fungerer uten TimesFM eller OpenAI API
- **Robust visualisering**: Ingen ekstra Highcharts-moduler kreves

## Filstruktur

```
spike/
â”œâ”€â”€ server.py             # API + pre-prosessering + chat
â”œâ”€â”€ prediction_service.py # TimesFM wrapper (NY)
â”œâ”€â”€ analysis_schema.py    # LLM input/output skjemaer
â”œâ”€â”€ apply_findings.py     # Funn â†’ Highcharts mapping
â”œâ”€â”€ visual_presets.py     # Farge/stil-presets
â”œâ”€â”€ index.html            # Frontend med chat og prediksjon
â”œâ”€â”€ 101.txt               # Denne dokumentasjonen
â””â”€â”€ README.md             # Bruker-dokumentasjon
```

## API Endepunkter v0.3

| Endepunkt | Metode | Beskrivelse |
|-----------|--------|-------------|
| `/` | GET | Serve frontend HTML |
| `/health` | GET | Helse-sjekk + modus-info |
| `/analyze` | POST | Semantisk analyse â†’ deterministisk output |
| `/chat` | POST | Interaktiv chat med automatisk prediksjon |
| `/predict` | POST | Direkte tidsserie-prediksjon |
| `/schema` | GET | JSON-skjema for analyse |
| `/finding-types` | GET | Liste over alle funn-typer |

## Chat-funksjonalitet

### Intent-deteksjon
Backend analyserer naturlig sprÃ¥k for prediksjons-intent:
- **NÃ¸kkelord**: "hva skjer", "fremtid", "prediksjon", "prognose", "hvis"
- **Tidsekstraksjon**: "neste 30 dager", "2 uker", "en mÃ¥ned"
- **Scenarioer**: "bullish", "bearish", "volatile"

### Respons-format
```json
{
  "response": "Prognosen viser en mulig oppgang pÃ¥ 15%...",
  "hasPrediction": true,
  "predictionData": {
    "predictions": [[ts, val], ...],
    "confidenceRange": [[ts, low, high], ...],
    "metadata": {"method": "timesfm", "horizon": 30},
    "analysis": {...}
  }
}
```
